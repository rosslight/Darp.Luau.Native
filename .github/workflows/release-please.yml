name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Resolve Luau version
        id: luau
        shell: bash
        run: |
          set -euo pipefail
          luau_tag="$(git -C native/luau describe --tags --exact-match 2>/dev/null || true)"
          if [[ -n "${luau_tag}" ]]; then
            luau_version="${luau_tag#v}"
          else
            luau_version="$(git -C native/luau rev-parse --short=12 HEAD)"
          fi
          echo "version=${luau_version}" >> "${GITHUB_OUTPUT}"
      - name: Update release-please manifest build metadata
        run: |
          set -euo pipefail
          luau_version="${{ steps.luau.outputs.version }}"
          current="$(jq -r '."."' .release-please-manifest.json)"
          base_version="${current%%+*}"
          new_version="${base_version}+luau.${luau_version}"
          jq --arg v "${new_version}" '.["."] = $v' .release-please-manifest.json > .release-please-manifest.json.tmp
          mv .release-please-manifest.json.tmp .release-please-manifest.json
          echo "Updated manifest version to: ${new_version}"
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json
